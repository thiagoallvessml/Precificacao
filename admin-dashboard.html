<!DOCTYPE html>
<html class="dark" lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Admin Dashboard - PrecificaX</title>
    <meta name="description" content="Painel administrativo para gerenciar usu√°rios e configura√ß√µes do sistema" />
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ecec",
                        "background-dark": "#0F0F0F",
                        "card-dark": "#1a2f2f",
                        "danger": "#ff4d4d",
                        "success": "#22c55e",
                        "warning": "#f59e0b"
                    },
                    fontFamily: {
                        "display": ["Work Sans", "sans-serif"]
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Work Sans', sans-serif;
            background: #0F0F0F;
        }

        .skeleton {
            background: linear-gradient(90deg, #1a2f2f 25%, #243f3f 50%, #1a2f2f 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .role-badge {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 3px 8px;
            border-radius: 6px;
        }

        .role-admin {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .role-dono {
            background: rgba(19, 236, 236, 0.15);
            color: #13ecec;
        }

        .role-afiliado {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .plan-badge {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 3px 8px;
            border-radius: 6px;
        }

        .plan-free {
            background: rgba(148, 163, 184, 0.15);
            color: #94a3b8;
        }

        .plan-premium {
            background: rgba(12, 237, 237, 0.15);
            color: #0ceded;
            box-shadow: 0 0 8px rgba(12, 237, 237, 0.1);
        }

        .user-row {
            transition: background 0.2s;
        }

        .user-row:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .stat-card {
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.3);
            }
        }

        .pulse-dot {
            animation: pulse-dot 2s ease-in-out infinite;
        }

        .online-tooltip {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #0F0F0F;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            min-width: 200px;
            max-width: 280px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 60;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .stat-card-online:hover .online-tooltip {
            display: block;
        }
    </style>
</head>

<body class="bg-background-dark text-slate-100 min-h-screen font-display">

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-background-dark/90 backdrop-blur-xl border-b border-white/5 px-4 py-3">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="assets/logo-precificax.png" alt="PrecificaX" class="w-8 h-8 rounded-full object-contain" />
                <div>
                    <h1 class="text-base font-bold text-white">Admin Dashboard</h1>
                    <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Painel Administrativo</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span id="adminName" class="text-sm text-gray-400 hidden sm:inline"></span>
                <button onclick="fazerLogout()"
                    class="p-2 rounded-lg hover:bg-white/5 transition-colors text-gray-500 hover:text-danger">
                    <span class="material-icons-round text-xl">logout</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
            <!-- Online Now -->
            <div
                class="stat-card stat-card-online relative bg-card-dark rounded-xl p-4 border border-success/20 md:col-span-1">
                <div class="flex items-center gap-2 mb-2">
                    <span class="w-2.5 h-2.5 rounded-full bg-success pulse-dot"></span>
                    <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Online Agora</span>
                </div>
                <div class="flex items-baseline gap-1">
                    <p id="statOnline" class="text-2xl font-bold text-success">0</p>
                    <span class="text-[10px] text-gray-600">usu√°rio(s)</span>
                </div>
                <!-- Tooltip com lista de usu√°rios online -->
                <div class="online-tooltip">
                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-2">Usu√°rios Online</p>
                    <div id="onlineUsersList" class="space-y-1.5">
                        <p class="text-xs text-gray-600 italic">Carregando...</p>
                    </div>
                </div>
            </div>

            <!-- Total -->
            <div class="stat-card bg-card-dark rounded-xl p-4 border border-white/5">
                <div class="flex items-center gap-2 mb-2">
                    <span class="material-icons-round text-primary text-lg">people</span>
                    <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Total Usu√°rios</span>
                </div>
                <p id="statTotal" class="text-2xl font-bold text-white">
                    <span class="skeleton inline-block h-7 w-10 rounded"></span>
                </p>
            </div>
            <div class="stat-card bg-card-dark rounded-xl p-4 border border-white/5">
                <div class="flex items-center gap-2 mb-2">
                    <span class="material-icons-round text-primary text-lg">storefront</span>
                    <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Donos</span>
                </div>
                <p id="statDonos" class="text-2xl font-bold text-white">
                    <span class="skeleton inline-block h-7 w-10 rounded"></span>
                </p>
            </div>
            <div class="stat-card bg-card-dark rounded-xl p-4 border border-white/5">
                <div class="flex items-center gap-2 mb-2">
                    <span class="material-icons-round text-warning text-lg">handshake</span>
                    <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Afiliados</span>
                </div>
                <p id="statAfiliados" class="text-2xl font-bold text-white">
                    <span class="skeleton inline-block h-7 w-10 rounded"></span>
                </p>
            </div>
            <div class="stat-card bg-card-dark rounded-xl p-4 border border-white/5">
                <div class="flex items-center gap-2 mb-2">
                    <span class="material-icons-round text-danger text-lg">admin_panel_settings</span>
                    <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Admins</span>
                </div>
                <p id="statAdmins" class="text-2xl font-bold text-white">
                    <span class="skeleton inline-block h-7 w-10 rounded"></span>
                </p>
            </div>
        </div>

        <!-- Users Table -->
        <div class="bg-card-dark rounded-xl border border-white/5 overflow-hidden">
            <div class="p-4 border-b border-white/5 flex items-center justify-between flex-wrap gap-3">
                <h2 class="text-sm font-bold text-white flex items-center gap-2">
                    <span class="material-icons-round text-primary text-lg">manage_accounts</span>
                    Gerenciar Usu√°rios
                </h2>
                <!-- Filter -->
                <div class="flex items-center gap-2">
                    <select id="filterRole" onchange="carregarUsuarios()"
                        class="bg-background-dark border border-white/10 rounded-lg text-xs text-gray-400 py-2 px-3 outline-none focus:border-primary">
                        <option value="">Todos</option>
                        <option value="admin">Admin</option>
                        <option value="dono">Dono</option>
                        <option value="afiliado">Afiliado</option>
                    </select>
                </div>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b border-white/5">
                            <th class="px-4 py-3 text-[10px] text-gray-500 font-bold uppercase tracking-wider">Usu√°rio
                            </th>
                            <th
                                class="px-4 py-3 text-[10px] text-gray-500 font-bold uppercase tracking-wider hidden sm:table-cell">
                                E-mail</th>
                            <th class="px-4 py-3 text-[10px] text-gray-500 font-bold uppercase tracking-wider">Role</th>
                            <th class="px-4 py-3 text-[10px] text-gray-500 font-bold uppercase tracking-wider">Plano
                            </th>
                            <th
                                class="px-4 py-3 text-[10px] text-gray-500 font-bold uppercase tracking-wider hidden md:table-cell">
                                Cadastro</th>
                            <th
                                class="px-4 py-3 text-[10px] text-gray-500 font-bold uppercase tracking-wider hidden lg:table-cell">
                                Premium Trial</th>
                            <th
                                class="px-4 py-3 text-[10px] text-gray-500 font-bold uppercase tracking-wider hidden md:table-cell">
                                Status</th>
                            <th class="px-4 py-3 text-[10px] text-gray-500 font-bold uppercase tracking-wider">A√ß√µes
                            </th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="8" class="p-8 text-center">
                                <div class="skeleton h-4 w-48 rounded mx-auto mb-3"></div>
                                <div class="skeleton h-4 w-36 rounded mx-auto"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
            <a href="index.html"
                class="bg-card-dark rounded-xl p-4 border border-white/5 flex items-center gap-3 hover:border-primary/30 transition-colors">
                <span class="material-icons-round text-primary text-xl">dashboard</span>
                <span class="text-sm font-semibold text-white">Menu Principal</span>
            </a>
            <a href="configuracoes-admin.html"
                class="bg-card-dark rounded-xl p-4 border border-white/5 flex items-center gap-3 hover:border-primary/30 transition-colors">
                <span class="material-icons-round text-primary text-xl">settings</span>
                <span class="text-sm font-semibold text-white">Configura√ß√µes</span>
            </a>
            <a href="faturamento-afiliados.html"
                class="bg-card-dark rounded-xl p-4 border border-white/5 flex items-center gap-3 hover:border-primary/30 transition-colors">
                <span class="material-icons-round text-primary text-xl">trending_up</span>
                <span class="text-sm font-semibold text-white">Faturamento Afiliados</span>
            </a>
            <a href="repasse-afiliado.html"
                class="bg-card-dark rounded-xl p-4 border border-white/5 flex items-center gap-3 hover:border-[#fb923c]/30 transition-colors">
                <span class="material-icons-round text-[#fb923c] text-xl">payments</span>
                <span class="text-sm font-semibold text-white">Repasse Afiliado</span>
            </a>
            <button onclick="fazerLogout()"
                class="bg-card-dark rounded-xl p-4 border border-white/5 flex items-center gap-3 hover:border-danger/30 transition-colors text-left">
                <span class="material-icons-round text-danger text-xl">logout</span>
                <span class="text-sm font-semibold text-white">Sair</span>
            </button>
        </div>
    </main>

    <!-- Modal: Alterar Role -->
    <div id="modalRole" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4"
        style="display:none;">
        <div class="bg-card-dark rounded-2xl max-w-sm w-full p-6 border border-white/10 space-y-5">
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-bold text-white">Alterar Tipo de Conta</h3>
                <button onclick="fecharModal()" class="p-1 rounded-full hover:bg-white/10 transition-colors">
                    <span class="material-icons-round text-gray-500">close</span>
                </button>
            </div>
            <p class="text-xs text-gray-400">
                Usu√°rio: <strong id="modalUserName" class="text-white"></strong>
            </p>
            <div class="space-y-2">
                <label class="text-[10px] text-gray-500 font-bold uppercase tracking-widest ml-1 block">Role</label>
                <select id="newRoleSelect"
                    class="w-full bg-background-dark border border-white/10 rounded-xl px-4 py-3 text-white text-sm outline-none focus:border-primary">
                    <option value="admin">Administrador</option>
                    <option value="dono">Dono do Neg√≥cio</option>
                    <option value="afiliado">Afiliado</option>
                </select>
            </div>
            <div class="space-y-2">
                <label class="text-[10px] text-gray-500 font-bold uppercase tracking-widest ml-1 block">Plano</label>
                <select id="newPlanoSelect"
                    class="w-full bg-background-dark border border-white/10 rounded-xl px-4 py-3 text-white text-sm outline-none focus:border-primary">
                    <option value="free">Free</option>
                    <option value="premium">‚≠ê Premium</option>
                </select>
            </div>
            <button onclick="salvarRole()"
                class="w-full bg-primary text-background-dark font-bold py-3 rounded-xl text-sm hover:brightness-110 transition-all">
                Salvar Altera√ß√µes
            </button>
        </div>
    </div>

    <script type="module">
        import { getSupabase } from './supabase-client.js';
        import { protectPage, logout } from './auth-guard.js';

        const supabase = getSupabase();
        let editingUserId = null;
        let presenceChannel = null;

        /**
         * Inicializa o monitoramento de presen√ßa (Realtime Presence)
         */
        function initPresenceMonitor() {
            if (!supabase) return;

            presenceChannel = supabase.channel('online-users', {
                config: {
                    presence: {
                        key: 'admin-monitor-' + Date.now(),
                    },
                },
            });

            presenceChannel
                .on('presence', { event: 'sync' }, () => {
                    updateOnlineCount();
                })
                .on('presence', { event: 'join' }, () => {
                    updateOnlineCount();
                })
                .on('presence', { event: 'leave' }, () => {
                    updateOnlineCount();
                })
                .subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        // Registrar o admin tamb√©m como presente
                        await presenceChannel.track({
                            online_at: new Date().toISOString(),
                            page: 'admin-dashboard.html'
                        });
                    }
                });
        }

        /**
         * Atualiza o contador de usu√°rios online
         */
        function updateOnlineCount() {
            if (!presenceChannel) return;

            const state = presenceChannel.presenceState();
            const usersMap = new Map();

            // Agrupar por user_id real (ignorar chaves duplicadas)
            for (const [key, presences] of Object.entries(state)) {
                if (presences && presences.length > 0) {
                    const p = presences[0];
                    const userId = p.user_id || key;
                    if (!usersMap.has(userId)) {
                        usersMap.set(userId, p);
                    }
                }
            }

            const count = usersMap.size;

            // Atualizar contador
            const statEl = document.getElementById('statOnline');
            statEl.textContent = count;

            // Atualizar lista de tooltip
            const listEl = document.getElementById('onlineUsersList');
            if (count === 0) {
                listEl.innerHTML = '<p class="text-xs text-gray-600 italic">Nenhum usu√°rio online</p>';
            } else {
                listEl.innerHTML = Array.from(usersMap.values()).map(u => {
                    const page = (u.page || 'desconhecida').replace('.html', '');
                    const email = u.email || 'Usu√°rio';
                    return `
                        <div class="flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-success shrink-0"></span>
                            <div class="min-w-0">
                                <p class="text-xs text-white truncate">${email}</p>
                                <p class="text-[10px] text-gray-600">üìÑ ${page}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Proteger p√°gina ‚Äî somente admin
        async function init() {
            const perfil = await protectPage(['admin']);
            if (!perfil) return;

            document.getElementById('adminName').textContent = perfil.nome || perfil.email;

            // Iniciar monitoramento de presen√ßa
            initPresenceMonitor();

            await carregarUsuarios();
        }

        // Carregar usu√°rios
        window.carregarUsuarios = async function () {
            if (!supabase) return;

            const filter = document.getElementById('filterRole').value;
            let query = supabase.from('perfis_usuarios').select('*').order('created_at', { ascending: false });

            if (filter) {
                query = query.eq('role', filter);
            }

            const { data, error } = await query;

            if (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                return;
            }

            // Stats
            const total = data.length;
            const donos = data.filter(u => u.role === 'dono').length;
            const afiliados = data.filter(u => u.role === 'afiliado').length;
            const admins = data.filter(u => u.role === 'admin').length;

            if (!filter) {
                document.getElementById('statTotal').textContent = total;
                document.getElementById('statDonos').textContent = donos;
                document.getElementById('statAfiliados').textContent = afiliados;
                document.getElementById('statAdmins').textContent = admins;
            }

            // Table
            const tbody = document.getElementById('usersTableBody');

            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="p-8 text-center text-gray-600 text-sm">
                            Nenhum usu√°rio encontrado.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.map(u => {
                const roleClass = `role-${u.role}`;
                const roleLabel = { admin: 'Admin', dono: 'Dono', afiliado: 'Afiliado' }[u.role] || u.role;
                const initials = (u.nome || u.email || '??').substring(0, 2).toUpperCase();
                const cadastroDate = new Date(u.created_at);
                const cadastroStr = cadastroDate.toLocaleDateString('pt-BR');
                const cadastroHora = cadastroDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                // Premium trial: 7 dias a partir do cadastro
                const premiumInfo = calcPremiumTrial(u.created_at);

                // Plano do usu√°rio
                const plano = u.plano || 'free';
                const planoClass = `plan-${plano}`;
                const planoLabel = plano === 'premium' ? '‚≠ê Premium' : 'Free';
                const planoIcon = plano === 'premium' ? 'star' : 'remove_circle_outline';

                return `
                    <tr class="user-row border-b border-white/5">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
                                    <span class="text-xs font-bold text-primary">${initials}</span>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-white">${u.nome || '‚Äî'}</p>
                                    <p class="text-[10px] text-gray-600 sm:hidden">${u.email}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-xs text-gray-400 hidden sm:table-cell">${u.email}</td>
                        <td class="px-4 py-3">
                            <span class="role-badge ${roleClass}">${roleLabel}</span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="plan-badge ${planoClass}">${planoLabel}</span>
                        </td>
                        <td class="px-4 py-3 hidden md:table-cell">
                            <div>
                                <p class="text-xs text-white font-medium">${cadastroStr}</p>
                                <p class="text-[10px] text-gray-600">${cadastroHora}</p>
                            </div>
                        </td>
                        <td class="px-4 py-3 hidden lg:table-cell">
                            <div class="flex flex-col gap-0.5">
                                <span class="text-[10px] font-bold ${premiumInfo.active ? 'text-success' : 'text-danger'}">
                                    ${premiumInfo.active ? '‚óè Ativo' : '‚óè Expirado'}
                                </span>
                                <span class="text-[10px] ${premiumInfo.active ? 'text-primary' : 'text-gray-600'}">
                                    ${premiumInfo.label}
                                </span>
                            </div>
                        </td>
                        <td class="px-4 py-3 hidden md:table-cell">
                            <span class="text-[10px] font-bold ${u.ativo ? 'text-success' : 'text-danger'}">
                                ${u.ativo ? '‚óè Ativo' : '‚óè Inativo'}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <button onclick="abrirModalRole('${u.id}', '${(u.nome || '').replace(/'/g, '\\&#39;')}', '${u.role}', '${plano}')" 
                                class="p-1.5 rounded-lg hover:bg-white/5 transition-colors text-gray-500 hover:text-primary"
                                title="Editar usu√°rio">
                                <span class="material-icons-round text-lg">edit</span>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        // Modal
        window.abrirModalRole = function (userId, userName, currentRole, currentPlano) {
            editingUserId = userId;
            document.getElementById('modalUserName').textContent = userName || userId;
            document.getElementById('newRoleSelect').value = currentRole;
            document.getElementById('newPlanoSelect').value = currentPlano || 'free';
            const modal = document.getElementById('modalRole');
            modal.style.display = 'flex';
            modal.classList.remove('hidden');
        };

        window.fecharModal = function () {
            const modal = document.getElementById('modalRole');
            modal.style.display = 'none';
            modal.classList.add('hidden');
            editingUserId = null;
        };

        window.salvarRole = async function () {
            if (!editingUserId || !supabase) return;

            const newRole = document.getElementById('newRoleSelect').value;
            const newPlano = document.getElementById('newPlanoSelect').value;

            const updateData = { role: newRole, plano: newPlano };

            // Se mudou para premium, gravar data de in√≠cio
            if (newPlano === 'premium') {
                updateData.premium_inicio = new Date().toISOString();
            } else {
                updateData.premium_inicio = null;
            }

            const { error } = await supabase
                .from('perfis_usuarios')
                .update(updateData)
                .eq('id', editingUserId);

            if (error) {
                alert('Erro ao salvar: ' + error.message);
                return;
            }

            fecharModal();
            await carregarUsuarios();
        };

        // Logout
        window.fazerLogout = async function () {
            if (confirm('Tem certeza que deseja sair?')) {
                await logout();
            }
        };

        /**
         * Calcula o status do premium trial (7 dias)
         */
        function calcPremiumTrial(createdAt) {
            const TRIAL_DAYS = 7;
            const created = new Date(createdAt);
            const expira = new Date(created.getTime() + TRIAL_DAYS * 24 * 60 * 60 * 1000);
            const agora = new Date();
            const diffMs = expira.getTime() - agora.getTime();

            if (diffMs > 0) {
                // Trial ativo
                const dias = Math.floor(diffMs / (24 * 60 * 60 * 1000));
                const horas = Math.floor((diffMs % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));

                if (dias > 0) {
                    return { active: true, label: `${dias}d ${horas}h restantes` };
                } else if (horas > 0) {
                    const mins = Math.floor((diffMs % (60 * 60 * 1000)) / (60 * 1000));
                    return { active: true, label: `${horas}h ${mins}m restantes` };
                } else {
                    const mins = Math.floor(diffMs / (60 * 1000));
                    return { active: true, label: `${mins}m restantes` };
                }
            } else {
                // Trial expirado
                const diasExpirado = Math.floor(Math.abs(diffMs) / (24 * 60 * 60 * 1000));
                if (diasExpirado === 0) {
                    return { active: false, label: 'Expirou hoje' };
                }
                return { active: false, label: `Expirou h√° ${diasExpirado}d` };
            }
        }

        // Init
        init();
    </script>
</body>

</html>
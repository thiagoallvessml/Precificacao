<!DOCTYPE html>
<html class="dark" lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Finalizar Assinatura - Gestão Geladinhos</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0ceded",
                        "background-dark": "#0F0F0F",
                        "card-dark": "#1a1a1a",
                        "input-dark": "#141420",
                    },
                    fontFamily: {
                        "display": ["Work Sans", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "1rem",
                        "xl": "1.5rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Work Sans', sans-serif;
            background-color: #0F0F0F;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-effect {
            background: rgba(15, 15, 15, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-footer {
            background: rgba(15, 15, 15, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        input::placeholder {
            color: #4b5563;
        }

        .payment-option {
            transition: all 0.2s ease;
        }

        .payment-option.selected {
            border-color: #0ceded;
            background: rgba(12, 237, 237, 0.03);
        }

        .payment-option:not(.selected):hover {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .coupon-success {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }



        .cta-pulse {
            animation: ctaPulse 2s ease-in-out infinite;
        }

        @keyframes ctaPulse {

            0%,
            100% {
                box-shadow: 0 4px 20px rgba(12, 237, 237, 0.15);
            }

            50% {
                box-shadow: 0 4px 30px rgba(12, 237, 237, 0.3);
            }
        }
    </style>
</head>

<body class="text-white min-h-screen pb-40 font-display">
    <!-- Header -->
    <header class="sticky top-0 z-50 glass-effect px-4 py-4 flex items-center">
        <button onclick="window.location.href='planos.html'"
            class="p-2 -ml-2 text-primary flex items-center rounded-full hover:bg-primary/10 transition-colors">
            <span class="material-icons-round">arrow_back_ios_new</span>
        </button>
        <h1 class="flex-1 text-center text-lg font-bold tracking-tight mr-8">Finalizar Assinatura</h1>
    </header>

    <main class="max-w-3xl mx-auto px-5 pt-6">
        <!-- Desktop: two columns -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">

            <!-- LEFT COLUMN (wider): Plan + Coupon + Payment -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Plano Selecionado -->
                <section class="bg-card-dark rounded-xl p-5 border border-white/5">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-gray-500 text-[10px] font-bold uppercase tracking-widest">Plano Selecionado
                            </h2>
                            <p id="planName" class="text-lg font-bold mt-1">Plano Premium Mensal</p>
                        </div>
                        <div class="text-right">
                            <p id="planPrice" class="text-xl font-black">R$ 39,90</p>
                            <p id="planPeriod" class="text-[10px] text-gray-500">cobrado mensalmente</p>
                        </div>
                    </div>
                    <button onclick="window.location.href='planos.html'"
                        class="mt-3 text-primary text-xs font-bold flex items-center gap-1 hover:underline">
                        <span class="material-icons-round text-sm">swap_horiz</span>
                        Trocar plano
                    </button>
                </section>

                <!-- Cupom -->
                <section class="space-y-3">
                    <label class="text-sm font-medium text-gray-400 ml-1">Cupom de Desconto</label>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <input id="couponInput"
                                class="w-full bg-input-dark border border-white/10 rounded-lg px-4 py-3 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all uppercase font-bold tracking-wide"
                                placeholder="Digite seu cupom" type="text" />
                        </div>
                        <button id="couponBtn" onclick="aplicarCupom()"
                            class="bg-primary/10 text-primary px-6 py-3 rounded-lg font-bold hover:bg-primary/20 transition-colors active:scale-95 whitespace-nowrap">
                            Aplicar
                        </button>
                    </div>
                    <!-- Coupon feedback -->
                    <div id="couponFeedback" class="hidden"></div>
                </section>

                <!-- Forma de Pagamento -->
                <section class="space-y-4">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest ml-1">Forma de Pagamento</h3>

                    <!-- PIX -->
                    <div
                        class="payment-option selected flex items-center gap-4 bg-card-dark p-4 rounded-xl border-2 border-primary">
                        <div class="w-6 h-6 rounded-full border-2 border-primary flex items-center justify-center">
                            <div class="w-3 h-3 bg-primary rounded-full"></div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="material-icons-round text-primary">qr_code_2</span>
                            <span class="font-bold">Pix</span>
                        </div>
                        <span
                            class="ml-auto text-[10px] bg-primary/10 text-primary px-2 py-1 rounded font-bold uppercase">Instantâneo</span>
                    </div>
                </section>
            </div>

            <!-- RIGHT COLUMN (narrower): Summary -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Resumo -->
                <section class="bg-card-dark rounded-xl p-5 border border-white/5 space-y-3 lg:sticky lg:top-24">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4">Resumo do Pedido</h3>
                    <div class="flex justify-between text-sm text-gray-300">
                        <span>Subtotal</span>
                        <span id="subtotal">R$ 39,90</span>
                    </div>
                    <div id="discountRow" class="flex justify-between text-sm text-primary hidden">
                        <span id="discountLabel">Desconto (10%)</span>
                        <span id="discountValue">- R$ 3,99</span>
                    </div>
                    <div class="h-px bg-white/5 my-2"></div>
                    <div class="flex justify-between items-center pt-1">
                        <span class="text-base font-bold">Total a Pagar</span>
                        <span id="totalValue" class="text-2xl font-black text-white">R$ 39,90</span>
                    </div>

                    <!-- Selo de segurança -->
                    <div class="flex items-center justify-center gap-2 pt-4 border-t border-white/5 mt-4">
                        <span class="material-icons-round text-emerald-400 text-sm">lock</span>
                        <span class="text-[10px] text-gray-500 font-medium">Pagamento 100% seguro e criptografado</span>
                    </div>

                    <!-- Garantia -->
                    <div class="bg-primary/5 border border-primary/10 rounded-lg p-3 mt-3">
                        <div class="flex items-center gap-2">
                            <span class="material-icons-round text-primary text-lg">verified_user</span>
                            <div>
                                <p class="text-xs font-bold text-primary">Garantia de 7 dias</p>
                                <p class="text-[10px] text-gray-500">Não gostou? Devolvemos 100% do valor.</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Footer CTA (fixed) -->
    <div class="fixed bottom-0 left-0 right-0 p-5 glass-footer">
        <div class="max-w-3xl mx-auto">
            <button id="ctaBtn" onclick="confirmarPagamento()"
                class="cta-pulse w-full bg-primary text-background-dark py-4 rounded-xl font-black text-lg shadow-lg shadow-primary/20 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                <span class="material-icons-round">arrow_forward</span>
                Ir para Pagamento
            </button>
            <p class="text-center text-[10px] text-gray-600 mt-3 px-4">
                Ao confirmar, você concorda com nossos
                <a class="text-gray-400 hover:text-primary cursor-pointer">Termos de Uso</a> e
                <a class="text-gray-400 hover:text-primary cursor-pointer">Política de Privacidade</a>.
            </p>
        </div>
    </div>

    <script type="module">
        import { getSupabase } from './supabase-client.js';

        const supabase = getSupabase();

        // Estado
        let precoBase = 39.90;
        let desconto = 0;
        let cupomAplicado = false;
        let cupomData = null; // dados do cupom do Supabase
        let metodoPagamento = 'pix';

        // Ler parâmetros da URL (plano e billing)
        const params = new URLSearchParams(window.location.search);
        const billing = params.get('billing') || 'mensal';

        if (billing === 'anual') {
            precoBase = 383.04;
            document.getElementById('planName').textContent = 'Plano Premium Anual';
            document.getElementById('planPrice').textContent = 'R$ 383,04';
            document.getElementById('planPeriod').textContent = 'cobrado anualmente';
            document.getElementById('subtotal').textContent = 'R$ 383,04';
            document.getElementById('totalValue').textContent = 'R$ 383,04';
        }

        // Aplicar cupom — busca no Supabase
        window.aplicarCupom = async function () {
            const input = document.getElementById('couponInput');
            const feedback = document.getElementById('couponFeedback');
            const btn = document.getElementById('couponBtn');
            const code = input.value.trim().toUpperCase();

            if (!code) {
                feedback.innerHTML = `
                    <div class="flex items-center gap-2 px-1 text-red-400 text-sm">
                        <span class="material-icons-round text-sm">error</span>
                        <p class="font-medium">Digite um código de cupom</p>
                    </div>
                `;
                feedback.classList.remove('hidden');
                return;
            }

            // Mostrar loading
            btn.disabled = true;
            btn.textContent = '...';

            try {
                let cupomEncontrado = null;

                if (supabase) {
                    // Buscar cupom no Supabase
                    const { data, error } = await supabase
                        .from('cupons_afiliado')
                        .select('*')
                        .eq('codigo', code)
                        .eq('ativo', true)
                        .single();

                    if (!error && data) {
                        cupomEncontrado = data;
                    }
                }

                if (cupomEncontrado) {
                    const percentual = cupomEncontrado.desconto_percentual;
                    desconto = precoBase * (percentual / 100);
                    cupomAplicado = true;
                    cupomData = cupomEncontrado;

                    input.disabled = true;
                    input.classList.add('opacity-60');

                    btn.textContent = 'Remover';
                    btn.onclick = removerCupom;
                    btn.disabled = false;
                    btn.className = 'bg-red-500/10 text-red-400 px-6 py-3 rounded-lg font-bold hover:bg-red-500/20 transition-colors active:scale-95 whitespace-nowrap';

                    feedback.innerHTML = `
                        <div class="coupon-success flex items-center gap-2 px-1">
                            <span class="material-icons-round text-primary text-sm">check_circle</span>
                            <p class="text-primary text-sm font-medium">Cupom aplicado! ${percentual}% de desconto</p>
                            <span class="ml-auto text-primary text-sm font-bold">- R$ ${desconto.toFixed(2).replace('.', ',')}</span>
                        </div>
                    `;
                    feedback.classList.remove('hidden');

                    // Atualizar resumo
                    document.getElementById('discountLabel').textContent = `Desconto (${percentual}%)`;
                    document.getElementById('discountValue').textContent = `- R$ ${desconto.toFixed(2).replace('.', ',')}`;
                    document.getElementById('discountRow').classList.remove('hidden');

                    atualizarTotal();
                } else {
                    btn.textContent = 'Aplicar';
                    btn.disabled = false;
                    feedback.innerHTML = `
                        <div class="flex items-center gap-2 px-1 text-red-400 text-sm">
                            <span class="material-icons-round text-sm">error</span>
                            <p class="font-medium">Cupom inválido ou expirado</p>
                        </div>
                    `;
                    feedback.classList.remove('hidden');
                }
            } catch (err) {
                console.error('Erro ao validar cupom:', err);
                btn.textContent = 'Aplicar';
                btn.disabled = false;
                feedback.innerHTML = `
                    <div class="flex items-center gap-2 px-1 text-red-400 text-sm">
                        <span class="material-icons-round text-sm">error</span>
                        <p class="font-medium">Erro ao validar cupom. Tente novamente.</p>
                    </div>
                `;
                feedback.classList.remove('hidden');
            }
        };

        // Remover cupom
        window.removerCupom = function () {
            desconto = 0;
            cupomAplicado = false;
            cupomData = null;

            const input = document.getElementById('couponInput');
            input.disabled = false;
            input.classList.remove('opacity-60');
            input.value = '';

            const btn = document.getElementById('couponBtn');
            btn.textContent = 'Aplicar';
            btn.onclick = window.aplicarCupom;
            btn.className = 'bg-primary/10 text-primary px-6 py-3 rounded-lg font-bold hover:bg-primary/20 transition-colors active:scale-95 whitespace-nowrap';

            document.getElementById('couponFeedback').classList.add('hidden');
            document.getElementById('discountRow').classList.add('hidden');

            atualizarTotal();
        };

        // Atualizar total
        function atualizarTotal() {
            const total = precoBase - desconto;
            document.getElementById('totalValue').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        // Confirmar pagamento — passa dados do cupom para a página Pix
        window.confirmarPagamento = function () {
            const total = (precoBase - desconto).toFixed(2);
            let url = `pix-pagamento.html?total=${total}`;

            if (cupomAplicado && cupomData) {
                url += `&cupom=${encodeURIComponent(cupomData.codigo)}`;
                url += `&cupom_id=${cupomData.id}`;
                url += `&desconto_pct=${cupomData.desconto_percentual}`;
                url += `&comissao_pct=${cupomData.comissao_percentual}`;
                url += `&valor_desconto=${desconto.toFixed(2)}`;
            }

            window.location.href = url;
        };
    </script>
</body>

</html>
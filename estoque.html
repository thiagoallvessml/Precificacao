<!DOCTYPE html>
<html class="dark" lang="pt-br">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ecec",
                        "background-light": "#f6f8f8",
                        "background-dark": "#0F0F0F",
                        "card-dark": "#1a2f2f",
                    },
                    fontFamily: {
                        "display": ["Work Sans"],
                        "sans": ["Work Sans"]
                    },
                },
            },
        }
    </script>
    <title>Estoque de Produtos</title>
    <style>
        .glass-header {
            background: rgba(15, 15, 15, 0.7);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body class="bg-background-dark font-display text-white min-h-screen pb-24">
    <!-- Top Navigation Bar -->
    <nav class="sticky top-0 z-50 glass-header px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="bg-primary/20 p-2 rounded-lg cursor-pointer" onclick="window.location.href='index.html'">
                <span class="material-symbols-outlined text-primary">arrow_back</span>
            </div>
            <h1 class="text-xl font-bold tracking-tight">Estoque de Produtos</h1>
        </div>
        <button onclick="window.location.href='producao.html'"
            class="bg-primary text-background-dark px-4 py-2 rounded-lg font-semibold hover:bg-primary/90 transition-all flex items-center gap-2">
            <span class="material-symbols-outlined">add</span>
            Produzir
        </button>
    </nav>

    <!-- Main Content -->
    <main class="p-4">
        <!-- Global Metrics -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
            <div class="flex flex-col gap-1 rounded-xl p-4 bg-card-dark border border-white/5 shadow-sm">
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Total Produtos</p>
                <p id="statTotalProdutos" class="text-2xl font-bold text-white">0</p>
            </div>
            <div class="flex flex-col gap-1 rounded-xl p-4 bg-card-dark border border-white/5 shadow-sm">
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Unidades</p>
                <p id="statTotalUnidades" class="text-2xl font-bold text-white">0 <span
                        class="text-sm font-normal text-slate-500">un</span></p>
            </div>
            <div
                class="flex flex-col gap-1 rounded-xl p-4 bg-card-dark border-l-4 border-primary shadow-sm col-span-2 md:col-span-1">
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Valor Total</p>
                <p id="statValorTotal" class="text-xl font-bold text-primary">R$ 0,00</p>
            </div>
            <div class="flex flex-col gap-1 rounded-xl p-4 bg-card-dark border-l-4 border-amber-500 shadow-sm">
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Estoque Baixo</p>
                <p id="statBaixo" class="text-2xl font-bold text-amber-500">0</p>
            </div>
            <div class="flex flex-col gap-1 rounded-xl p-4 bg-card-dark border-l-4 border-red-500 shadow-sm">
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Zerados</p>
                <p id="statZerado" class="text-2xl font-bold text-red-500">0</p>
            </div>
        </div>

        <!-- Product Cards -->
        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest px-1 mb-3">Produtos em Estoque</h3>
        <div id="produtosList" class="space-y-3"></div>
    </main>

    <script type="module">
        import { getAllRecords } from './supabase-utils.js';

        let produtos = [];
        let producoes = [];
        let receitas = {};
        let estoque = {}; // { produto_id: quantidade }

        // Carregar dados
        async function loadDados() {
            try {
                // Carregar produtos (todos, dispon√≠veis)
                const { data: prodData, error: prodError } = await getAllRecords('produtos');
                if (prodError) throw prodError;
                produtos = (prodData || []).filter(p => p.disponivel);

                // Carregar produ√ß√µes
                const { data: producaoData, error: producaoError } = await getAllRecords('producoes');
                if (producaoError) throw producaoError;
                producoes = producaoData || [];

                // Carregar receitas
                const { data: recData, error: recError } = await getAllRecords('receitas');
                if (recError) throw recError;
                (recData || []).forEach(rec => {
                    receitas[rec.id] = rec;
                });

                console.log('üì¶ Produtos:', produtos.length, produtos.map(p => ({ id: p.id, nome: p.nome, receita_id: p.receita_id })));
                console.log('üì¶ Producoes:', producoes.length, producoes.map(p => ({ id: p.id, receita_id: p.receita_id, nome_receita: p.nome_receita, total_unidades: p.total_unidades })));
                console.log('üì¶ Receitas:', Object.values(receitas).map(r => ({ id: r.id, nome: r.nome })));

                calcularEstoque();
                calcularEstatisticas();
                renderProdutos();
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
            }
        }

        // Calcular estoque baseado em produ√ß√£o
        function calcularEstoque() {
            estoque = {};

            console.log('üì¶ [Estoque] Iniciando c√°lculo...');
            console.log('üì¶ [Estoque] Produtos carregados:', produtos.length, produtos.map(p => ({ id: p.id, nome: p.nome, receita_id: p.receita_id })));
            console.log('üì¶ [Estoque] Produ√ß√µes carregadas:', producoes.length, producoes.map(p => ({ id: p.id, receita_id: p.receita_id, nome_receita: p.nome_receita, total_unidades: p.total_unidades, quantidade_produzida: p.quantidade_produzida })));
            console.log('üì¶ [Estoque] Receitas carregadas:', Object.keys(receitas).length, Object.values(receitas).map(r => ({ id: r.id, nome: r.nome })));

            // === CAMADA 1: mapa receita_id ‚Üí produto.id (via produto.receita_id) ===
            const receitaIdParaProdutoId = {};
            produtos.forEach(produto => {
                if (produto.receita_id) {
                    receitaIdParaProdutoId[produto.receita_id] = produto.id;
                }
            });
            console.log('üì¶ [Estoque] Mapa receita_id‚Üíproduto_id:', receitaIdParaProdutoId);

            // === CAMADA 2: mapa nome da receita ‚Üí produto.id (via receitas[].nome ‚Üî produto.nome) ===
            const nomeReceitaParaProdutoId = {};
            Object.values(receitas).forEach(receita => {
                const nomeLower = (receita.nome || '').trim().toLowerCase();
                const produtoMatch = produtos.find(p => (p.nome || '').trim().toLowerCase() === nomeLower);
                if (produtoMatch) {
                    nomeReceitaParaProdutoId[receita.id] = produtoMatch.id;
                }
            });
            console.log('üì¶ [Estoque] Mapa nomeReceita‚Üíproduto_id:', nomeReceitaParaProdutoId);

            // Somar unidades produzidas por produto (tenta as 3 camadas em ordem)
            let naoAssociadas = 0;
            producoes.forEach(prod => {
                // Aceita total_unidades OU quantidade_produzida (compatibilidade)
                const unidades = prod.total_unidades || prod.quantidade_produzida || 0;

                // Camada 1: por receita_id ‚Üí produto.receita_id
                let produtoId = receitaIdParaProdutoId[prod.receita_id];

                // Camada 2: por receita_id ‚Üí nome da receita ‚Üí nome do produto
                if (!produtoId) {
                    produtoId = nomeReceitaParaProdutoId[prod.receita_id];
                }

                // Camada 3: por nome_receita direto ‚Üí nome do produto
                if (!produtoId && prod.nome_receita) {
                    const nomeProdLower = prod.nome_receita.trim().toLowerCase();
                    const produtoMatch = produtos.find(p => (p.nome || '').trim().toLowerCase() === nomeProdLower);
                    if (produtoMatch) produtoId = produtoMatch.id;
                }

                if (!produtoId) {
                    console.warn('üì¶ [Estoque] Produ√ß√£o SEM produto associado:', prod);
                    naoAssociadas++;
                    return;
                }

                if (!estoque[produtoId]) estoque[produtoId] = 0;
                estoque[produtoId] += unidades;
                console.log(`üì¶ [Estoque] Produto ${produtoId} +${unidades} unidades (prod #${prod.id})`);
            });

            console.log('üì¶ [Estoque] Resultado final:', estoque);
            if (naoAssociadas > 0) {
                console.warn(`üì¶ [Estoque] ‚ö†Ô∏è ${naoAssociadas} produ√ß√£o(√µes) sem produto associado! Verifique se os produtos t√™m receita_id preenchido ou se o nome do produto bate com o nome da receita.`);
            }

            // TODO: Subtrair vendas quando a tabela pedidos_itens estiver integrada
        }

        // Calcular estat√≠sticas
        function calcularEstatisticas() {
            const produtosComEstoque = Object.keys(estoque).length;
            const totalUnidades = Object.values(estoque).reduce((sum, qtd) => sum + qtd, 0);

            let baixo = 0;
            let zerado = 0;
            let valorTotal = 0;

            produtos.forEach(produto => {
                const qtd = estoque[produto.id] || 0;
                const preco = parseFloat(produto.preco_base || 0);
                valorTotal += qtd * preco;
                if (qtd === 0) zerado++;
                else if (qtd <= 10) baixo++;
            });

            document.getElementById('statTotalProdutos').textContent = produtosComEstoque;
            document.getElementById('statTotalUnidades').innerHTML = `${totalUnidades} <span class="text-sm font-normal text-slate-500">un</span>`;
            document.getElementById('statValorTotal').textContent = `R$ ${valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('statBaixo').textContent = baixo;
            document.getElementById('statZerado').textContent = zerado;
        }

        // Renderizar produtos
        function renderProdutos() {
            const container = document.getElementById('produtosList');

            if (produtos.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-slate-400">
                        <span class="material-symbols-outlined text-6xl mb-4 opacity-30">icecream</span>
                        <p>Nenhum produto cadastrado</p>
                    </div>
                `;
                return;
            }

            // Ordenar por quantidade em estoque (maior primeiro)
            const sorted = [...produtos].sort((a, b) => (estoque[b.id] || 0) - (estoque[a.id] || 0));

            container.innerHTML = sorted.map(produto => {
                const qtd = estoque[produto.id] || 0;
                const preco = parseFloat(produto.preco_base || 0);
                const valorTotal = qtd * preco;

                let badgeClass = 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20';
                if (qtd === 0) badgeClass = 'bg-red-500/10 text-red-500 border-red-500/20';
                else if (qtd <= 10) badgeClass = 'bg-amber-500/10 text-amber-500 border-amber-500/20';

                return `
                    <div class="bg-card-dark rounded-xl p-4 border border-white/5 flex flex-col gap-3 hover:border-primary/30 transition-colors">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-3">
                                ${produto.imagem_url
                        ? `<img src="${produto.imagem_url}" class="w-12 h-12 rounded-lg object-cover" />`
                        : `<div class="w-12 h-12 rounded-lg bg-white/5 flex items-center justify-center">
                                         <span class="material-symbols-outlined text-slate-300">icecream</span>
                                       </div>`
                    }
                                <div>
                                    <h4 class="font-bold text-sm text-white">${produto.nome}</h4>
                                    ${produto.descricao ? `<p class="text-[10px] text-slate-400">${produto.descricao}</p>` : ''}
                                </div>
                            </div>
                            <span class="px-2.5 py-1 ${badgeClass} text-xs font-bold rounded-lg border whitespace-nowrap">
                                ${qtd} un
                            </span>
                        </div>
                        <div class="grid grid-cols-3 gap-4 border-t border-white/5 pt-3">
                            <div>
                                <p class="text-[10px] text-slate-500 uppercase font-bold mb-0.5">Pre√ßo</p>
                                <p class="text-sm font-semibold text-white">R$ ${preco.toFixed(2)}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-[10px] text-slate-500 uppercase font-bold mb-0.5">Estoque</p>
                                <p class="text-sm font-semibold ${qtd > 10 ? 'text-emerald-400' : qtd > 0 ? 'text-amber-400' : 'text-red-500'}">${qtd} un</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-slate-500 uppercase font-bold mb-0.5">Valor Total</p>
                                <p class="text-sm font-semibold text-primary">R$ ${valorTotal.toFixed(2)}</p>
                            </div>
                        </div>
                        ${qtd === 0 ? `
                            <button onclick="window.location.href='adicionar-producao.html'" 
                                class="w-full bg-red-500/20 hover:bg-red-500/30 text-red-400 py-2 rounded-lg text-sm font-semibold border border-red-500/30 transition-colors">
                                ‚ö†Ô∏è Repor Estoque
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Iniciar
        loadDados();
    </script>
</body>

</html>
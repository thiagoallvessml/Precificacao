<!DOCTYPE html>
<html class="dark" lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Gerenciar Insumos - Geladinhos</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ecec",
                        "background-light": "#f6f8f8",
                        "background-dark": "#0F0F0F",
                    },
                    fontFamily: {
                        "display": ["Work Sans"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Work Sans', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        select {
            transition: all 0.2s ease;
        }

        select:hover {
            border-color: rgba(19, 236, 236, 0.4);
        }

        select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(19, 236, 236, 0.1);
        }

        select option {
            background-color: #1a2828;
            color: #e2e8f0;
            padding: 12px 16px;
            font-weight: 400;
            transition: all 0.15s ease;
        }

        select option:hover {
            background-color: #1f3333 !important;
            color: #13ecec !important;
        }

        select option:checked,
        select option:focus {
            background: linear-gradient(135deg, #1f3333 0%, #1a2c2c 100%);
            color: #13ecec;
            font-weight: 500;
        }

        select option:disabled {
            color: #64748b;
            background-color: #1a2828;
            font-style: italic;
        }

        @media (max-width: 1023px) {
            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }
        }

        @media (min-width: 1024px) {
            .tab-content {
                display: block !important;
            }

            .mobile-segmented {
                display: none !important;
            }
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white min-h-screen">
    <!-- Header -->
    <header
        class="sticky top-0 z-50 bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-md border-b border-slate-200 dark:border-slate-800">
        <div class="flex items-center px-4 h-16 max-w-7xl mx-auto">
            <button onclick="window.location.href='gestao-insumos.html'"
                class="flex size-10 items-center justify-center rounded-full hover:bg-white/10 active:bg-white/20 transition-colors">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h1
                class="text-lg font-bold leading-tight tracking-tight flex-1 text-center lg:text-left lg:pl-4 pr-10 lg:pr-0">
                Gerenciar Insumos
            </h1>
        </div>

        <!-- Segmented Control - APENAS MOBILE -->
        <div class="mobile-segmented px-4 pb-4 max-w-[480px] mx-auto lg:hidden">
            <div
                class="flex p-1 bg-slate-200 dark:bg-slate-800/50 rounded-xl border border-slate-300 dark:border-slate-700">
                <button id="btn-cadastro" onclick="switchTab('cadastro')"
                    class="tab-btn flex-1 py-2.5 text-sm font-semibold rounded-lg bg-primary text-background-dark shadow-sm transition-all">
                    Cadastrar Insumo
                </button>
                <button id="btn-entrada" onclick="switchTab('entrada')"
                    class="tab-btn flex-1 py-2.5 text-sm font-medium rounded-lg text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-all">
                    Entrada de Estoque
                </button>
            </div>
        </div>
    </header>

    <!-- Status Message -->
    <div id="statusMessage" class="hidden mx-4 mt-4"></div>

    <!-- LAYOUT RESPONSIVO: Mobile = Tabs, Desktop = Side by Side -->
    <div class="max-w-7xl mx-auto lg:grid lg:grid-cols-2 lg:gap-8 lg:px-8 lg:py-6">

        <!-- COLUNA 1: CADASTRO DE INSUMO -->
        <div id="tab-cadastro" class="tab-content active">
            <div
                class="lg:bg-white lg:dark:bg-slate-800/40 lg:rounded-2xl lg:border lg:border-slate-200 lg:dark:border-slate-700/50 lg:shadow-lg lg:h-full">
                <!-- T√≠tulo Desktop -->
                <div class="hidden lg:block px-6 pt-6 pb-4 border-b border-slate-200 dark:border-slate-700">
                    <div class="flex items-center gap-3">
                        <div class="bg-primary/10 dark:bg-primary/5 p-2 rounded-xl">
                            <span class="material-symbols-outlined text-primary text-2xl">add_box</span>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold">Cadastrar Insumo</h2>
                            <p class="text-sm text-slate-600 dark:text-slate-400">Adicione novos ingredientes ao estoque
                            </p>
                        </div>
                    </div>
                </div>

                <main class="max-w-[480px] lg:max-w-none mx-auto pb-32 lg:pb-6 px-4 lg:px-6">
                    <form id="formCadastro" class="space-y-4 pt-6">
                        <!-- Nome do Insumo -->
                        <div>
                            <label class="flex flex-col w-full">
                                <p
                                    class="text-sm font-semibold uppercase tracking-wider pb-2 px-1 text-slate-700 dark:text-slate-300">
                                    Nome do Insumo</p>
                                <input id="inputNome" required
                                    class="flex w-full rounded-xl bg-white dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 focus:ring-2 focus:ring-primary focus:border-transparent h-14 placeholder:text-slate-400 p-[15px] text-base font-medium shadow-sm"
                                    placeholder="Ex: Leite Condensado" type="text" />
                            </label>
                        </div>

                        <!-- Categoria -->
                        <div>
                            <label class="flex flex-col w-full">
                                <p
                                    class="text-sm font-semibold uppercase tracking-wider pb-2 px-1 text-slate-700 dark:text-slate-300">
                                    Tipo</p>
                                <select id="inputTipo" required
                                    class="flex w-full rounded-xl bg-white dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 focus:ring-2 focus:ring-primary focus:border-transparent h-14 px-[15px] text-base font-medium shadow-sm appearance-none bg-[url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27currentColor%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')] bg-[length:1.25rem] bg-[right_1rem_center] bg-no-repeat">
                                    <option value="" disabled selected>Carregando...</option>
                                </select>
                            </label>
                        </div>

                        <!-- Unidade de Medida -->
                        <div>
                            <label class="flex flex-col w-full">
                                <p
                                    class="text-sm font-semibold uppercase tracking-wider pb-2 px-1 text-slate-700 dark:text-slate-300">
                                    Unidade de Medida</p>
                                <select id="inputUnidade" required
                                    class="flex w-full rounded-xl bg-white dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 focus:ring-2 focus:ring-primary focus:border-transparent h-14 px-[15px] text-base font-medium shadow-sm appearance-none bg-[url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27currentColor%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e')] bg-[length:1.25rem] bg-[right_1rem_center] bg-no-repeat">
                                    <option value="kg">Quilograma (kg)</option>
                                    <option value="g">Grama (g)</option>
                                    <option value="l">Litro (l)</option>
                                    <option value="ml">Mililitro (ml)</option>
                                    <option value="un">Unidade (un)</option>
                                </select>
                            </label>
                        </div>

                        <!-- Estoque Inicial -->
                        <div>
                            <label class="flex flex-col w-full">
                                <p
                                    class="text-sm font-semibold uppercase tracking-wider pb-2 px-1 text-slate-700 dark:text-slate-300">
                                    Estoque Inicial</p>
                                <input id="inputEstoqueInicial" required value="0" min="0" step="0.001"
                                    class="flex w-full rounded-xl bg-white dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 focus:ring-2 focus:ring-primary focus:border-transparent h-14 placeholder:text-slate-400 p-[15px] text-base font-medium shadow-sm"
                                    inputmode="decimal" placeholder="Ex: 10" type="number" />
                            </label>
                        </div>

                        <!-- Estoque M√≠nimo -->
                        <div>
                            <label class="flex flex-col w-full">
                                <div class="flex items-center gap-2 pb-2 px-1">
                                    <p
                                        class="text-sm font-semibold uppercase tracking-wider text-slate-700 dark:text-slate-300">
                                        Estoque M√≠nimo (MOQ)</p>
                                    <span class="material-symbols-outlined text-xs text-slate-500">info</span>
                                </div>
                                <input id="inputEstoqueMinimo" required value="0" min="0" step="0.001"
                                    class="flex w-full rounded-xl bg-white dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 focus:ring-2 focus:ring-primary focus:border-transparent h-14 placeholder:text-slate-400 p-[15px] text-base font-medium shadow-sm"
                                    inputmode="decimal" placeholder="Ex: 5" type="number" />
                            </label>
                        </div>

                        <!-- Estoque M√°ximo -->
                        <div>
                            <label class="flex flex-col w-full">
                                <p
                                    class="text-sm font-semibold uppercase tracking-wider pb-2 px-1 text-slate-700 dark:text-slate-300">
                                    Estoque M√°ximo</p>
                                <input id="inputEstoqueMaximo" min="0" step="0.001"
                                    class="flex w-full rounded-xl bg-white dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 focus:ring-2 focus:ring-primary focus:border-transparent h-14 placeholder:text-slate-400 p-[15px] text-base font-medium shadow-sm"
                                    inputmode="decimal" placeholder="Ex: 50" type="number" />
                            </label>
                        </div>

                        <!-- Custo Unit√°rio -->
                        <div>
                            <label class="flex flex-col w-full">
                                <p
                                    class="text-sm font-semibold uppercase tracking-wider pb-2 px-1 text-slate-700 dark:text-slate-300">
                                    Custo Unit√°rio (R$)</p>
                                <input id="inputCusto" required value="0" min="0" step="0.001"
                                    class="flex w-full rounded-xl bg-white dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 focus:ring-2 focus:ring-primary focus:border-transparent h-14 placeholder:text-slate-400 p-[15px] text-base font-medium shadow-sm"
                                    inputmode="decimal" placeholder="Ex: 5.50" type="number" />
                            </label>
                        </div>

                        <!-- Fornecedor -->
                        <div>
                            <label class="flex flex-col w-full">
                                <p
                                    class="text-sm font-semibold uppercase tracking-wider pb-2 px-1 text-slate-700 dark:text-slate-300">
                                    Fornecedor (Opcional)</p>
                                <input id="inputFornecedor"
                                    class="flex w-full rounded-xl bg-white dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 focus:ring-2 focus:ring-primary focus:border-transparent h-14 placeholder:text-slate-400 p-[15px] text-base font-medium shadow-sm"
                                    placeholder="Ex: Nestl√©" type="text" />
                            </label>
                        </div>

                        <!-- Bot√£o Desktop -->
                        <div class="hidden lg:block pt-4">
                            <button type="submit"
                                class="w-full h-14 bg-primary hover:bg-primary/90 text-background-dark font-bold text-base rounded-xl shadow-lg active:scale-[0.98] transition-all flex items-center justify-center gap-3">
                                <span class="material-symbols-outlined">save</span>
                                Salvar Insumo
                            </button>
                        </div>
                    </form>
                </main>

                <!-- Fixed Footer - APENAS MOBILE -->
                <div
                    class="lg:hidden fixed bottom-0 left-0 right-0 bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-md border-t border-slate-200 dark:border-slate-800 px-4 pt-4 pb-6 z-50">
                    <div class="max-w-[480px] mx-auto">
                        <button form="formCadastro" type="submit"
                            class="w-full h-16 bg-primary hover:bg-primary/90 text-background-dark font-bold text-lg rounded-2xl shadow-xl active:scale-[0.97] transition-all flex items-center justify-center gap-3">
                            <span class="material-symbols-outlined">save</span>
                            Salvar Insumo
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLUNA 2: ENTRADA DE ESTOQUE -->
        <div id="tab-entrada" class="tab-content">
            <div
                class="lg:bg-white lg:dark:bg-slate-800/40 lg:rounded-2xl lg:border lg:border-slate-200 lg:dark:border-slate-700/50 lg:shadow-lg lg:h-full">
                <!-- T√≠tulo Desktop -->
                <div class="hidden lg:block px-6 pt-6 pb-4 border-b border-slate-200 dark:border-slate-700">
                    <div class="flex items-center gap-3">
                        <div class="bg-primary/10 dark:bg-primary/5 p-2 rounded-xl">
                            <span class="material-symbols-outlined text-primary text-2xl">inventory</span>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold">Entrada de Estoque</h2>
                            <p class="text-sm text-slate-600 dark:text-slate-400">Registre compras e atualize custos
                            </p>
                        </div>
                    </div>
                </div>

                <main class="max-w-[480px] lg:max-w-none mx-auto pb-32 lg:pb-6 px-4 lg:px-6">
                    <form id="formEntrada" class="pt-6 space-y-4">
                        <!-- Ingredient Selection -->
                        <div>
                            <label class="flex flex-col w-full">
                                <p class="text-sm font-medium leading-normal pb-2 text-slate-700 dark:text-slate-300">
                                    Insumo
                                </p>
                                <div class="relative">
                                    <select id="selectInsumo" required
                                        class="flex w-full rounded-xl bg-white dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 focus:ring-2 focus:ring-primary focus:border-transparent h-14 pl-4 pr-10 appearance-none text-base font-normal">
                                        <option disabled selected value="">Selecione um insumo</option>
                                    </select>
                                    <div
                                        class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                        <span class="material-symbols-outlined">expand_more</span>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <!-- Tipo de Custo -->
                        <div>
                            <p
                                class="text-sm font-semibold uppercase tracking-wider pb-2 px-1 text-slate-700 dark:text-slate-300">
                                Tipo de Custo</p>
                            <div
                                class="flex p-1 bg-slate-200 dark:bg-slate-800/50 rounded-xl border border-slate-300 dark:border-slate-700">
                                <button id="btnCustoUnitario" type="button" onclick="switchCustoMode('unitario')"
                                    class="custo-btn flex-1 py-2.5 text-sm font-semibold rounded-lg bg-primary text-background-dark shadow-sm transition-all">
                                    Custo Unit√°rio
                                </button>
                                <button id="btnCustoPacote" type="button" onclick="switchCustoMode('pacote')"
                                    class="custo-btn flex-1 py-2.5 text-sm font-medium rounded-lg text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-all">
                                    Valor do Pacote
                                </button>
                            </div>
                        </div>

                        <!-- Modo: Custo Unit√°rio -->
                        <div id="modoCustoUnitario" class="grid grid-cols-2 gap-4">
                            <div class="flex flex-col">
                                <p class="text-sm font-medium leading-normal pb-2 text-slate-700 dark:text-slate-300">
                                    Quantidade</p>
                                <input id="inputQtdUnitario" min="0" step="0.001"
                                    class="w-full h-16 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800/50 text-xl font-bold focus:ring-2 focus:ring-primary focus:border-transparent px-4 text-center"
                                    placeholder="1" type="number" />
                            </div>
                            <div class="flex flex-col">
                                <p class="text-sm font-medium leading-normal pb-2 text-slate-700 dark:text-slate-300">
                                    Custo Unit√°rio (R$)</p>
                                <input id="inputCustoUnitario" min="0" step="0.001"
                                    class="w-full h-16 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800/50 text-xl font-bold focus:ring-2 focus:ring-primary focus:border-transparent px-4"
                                    placeholder="0,00" type="number" />
                            </div>
                        </div>

                        <!-- Modo: Valor do Pacote -->
                        <div id="modoCustoPacote" class="hidden grid-cols-2 gap-4">
                            <div class="flex flex-col">
                                <p class="text-sm font-medium leading-normal pb-2 text-slate-700 dark:text-slate-300">
                                    Quantidade</p>
                                <input id="inputQtdPacote" min="0" step="0.001"
                                    class="w-full h-16 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800/50 text-xl font-bold focus:ring-2 focus:ring-primary focus:border-transparent px-4 text-center"
                                    placeholder="1" type="number" />
                            </div>
                            <div class="flex flex-col">
                                <p class="text-sm font-medium leading-normal pb-2 text-slate-700 dark:text-slate-300">
                                    Valor Total (R$)</p>
                                <input id="inputValorPacote" min="0" step="0.001"
                                    class="w-full h-16 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800/50 text-xl font-bold focus:ring-2 focus:ring-primary focus:border-transparent px-4"
                                    placeholder="0,00" type="number" />
                            </div>
                        </div>

                        <!-- Calculated Summary Card -->
                        <div class="mt-4">
                            <div
                                class="bg-primary/10 dark:bg-primary/5 border border-primary/30 rounded-2xl p-5 flex items-center justify-between">
                                <div>
                                    <p class="text-primary/80 text-xs font-semibold uppercase tracking-widest mb-1">
                                        Custo Unit√°rio M√©dio</p>
                                    <div class="flex items-baseline gap-1">
                                        <span class="text-primary text-sm font-bold">R$</span>
                                        <span id="custoCalculado" class="text-primary text-3xl font-bold">0,00</span>
                                    </div>
                                </div>
                                <div class="bg-primary/20 p-3 rounded-full">
                                    <span class="material-symbols-outlined text-primary text-3xl">calculate</span>
                                </div>
                            </div>
                        </div>

                        <!-- Bot√£o Desktop -->
                        <div class="hidden lg:block pt-4">
                            <button type="submit"
                                class="w-full h-14 bg-primary hover:bg-primary/90 text-background-dark font-bold text-base rounded-xl shadow-lg active:scale-[0.98] transition-all flex items-center justify-center gap-3">
                                <span class="material-symbols-outlined">check_circle</span>
                                Confirmar Entrada
                            </button>
                        </div>
                    </form>
                </main>

                <!-- Fixed Footer - APENAS MOBILE -->
                <footer
                    class="lg:hidden fixed bottom-0 left-0 right-0 p-4 bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-md border-t border-slate-200 dark:border-slate-800 max-w-[480px] mx-auto w-full">
                    <button form="formEntrada" type="submit"
                        class="w-full bg-primary hover:bg-primary/90 text-background-dark font-bold text-lg py-4 rounded-xl transition-all flex items-center justify-center gap-2 shadow-lg active:scale-[0.97]">
                        <span class="material-symbols-outlined">check_circle</span>
                        Confirmar Entrada
                    </button>
                </footer>
            </div>
        </div>
    </div>

    <script type="module">
        import { getAllRecords, insertRecord, updateRecord } from './supabase-utils.js';

        let insumos = [];

        // Carregar insumos para o select
        async function loadInsumos() {
            try {
                console.log('üîç Carregando insumos...');

                const { data, error } = await getAllRecords('insumos');

                console.log('üì¶ Resposta:', { data, error });

                if (error) throw error;

                // Filtrar apenas ingredientes e embalagens (excluir equipamentos)
                insumos = (data || []).filter(item =>
                    item.tipo === 'ingrediente' || item.tipo === 'embalagem'
                );

                console.log(`‚úÖ ${insumos.length} insumos carregados (ingredientes e embalagens)`);

                const select = document.getElementById('selectInsumo');

                if (!select) {
                    console.error('‚ùå Select #selectInsumo n√£o encontrado!');
                    return;
                }

                select.innerHTML = '<option disabled selected value="">Selecione um insumo</option>';

                // Ordenar alfabeticamente pelo nome
                const insumosOrdenados = [...insumos].sort((a, b) =>
                    a.nome.localeCompare(b.nome, 'pt-BR', { sensitivity: 'base' })
                );

                insumosOrdenados.forEach(insumo => {
                    const option = document.createElement('option');
                    option.value = insumo.id;
                    option.textContent = `${insumo.nome} (${insumo.unidade_medida})`;
                    select.appendChild(option);
                });

                console.log('‚úÖ Select preenchido com sucesso!');

            } catch (error) {
                console.error('‚ùå Erro ao carregar insumos:', error);
                showStatus('‚ùå Erro ao carregar insumos: ' + error.message, 'error');
            }
        }

        // Carregar categorias de insumos do Supabase
        async function loadCategoriasInsumos() {
            try {
                console.log('üîç Carregando categorias de insumos...');

                const select = document.getElementById('inputTipo');

                if (!select) {
                    console.error('‚ùå Select #inputTipo n√£o encontrado!');
                    return;
                }

                // Buscar categorias do tipo 'insumos' do Supabase
                const { data: categorias, error } = await getAllRecords('categorias');

                if (error) throw error;

                // Filtrar apenas categorias do tipo 'insumos' e armazenar globalmente
                categoriasInsumos = (categorias || []).filter(cat => cat.tipo === 'insumos' && cat.ativo);

                console.log(`‚úÖ ${categoriasInsumos.length} categorias de insumos encontradas`);

                // Limpar e preencher select
                select.innerHTML = '<option value="" disabled selected>Selecione uma categoria</option>';

                categoriasInsumos.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria.id;
                    // Exibir apenas o nome, sem o √≠cone
                    option.textContent = categoria.nome;
                    select.appendChild(option);
                });

                console.log('‚úÖ Select de categorias preenchido com sucesso!');

            } catch (error) {
                console.error('‚ùå Erro ao carregar categorias:', error);
                showStatus('‚ùå Erro ao carregar categorias: ' + error.message, 'error');
            }
        }

        // Vari√°vel global para armazenar categorias
        let categoriasInsumos = [];

        // Form de Cadastro
        document.getElementById('formCadastro').addEventListener('submit', async (e) => {
            e.preventDefault();

            const categoriaId = parseInt(document.getElementById('inputTipo').value);

            // Encontrar a categoria selecionada para determinar o tipo
            const categoriaSelecionada = categoriasInsumos.find(cat => cat.id === categoriaId);

            // Determinar o tipo baseado no nome da categoria
            let tipo = 'ingrediente'; // Padr√£o
            if (categoriaSelecionada) {
                const nomeCategoria = categoriaSelecionada.nome.toLowerCase();
                if (nomeCategoria.includes('embalagem')) {
                    tipo = 'embalagem';
                } else if (nomeCategoria.includes('equipamento')) {
                    tipo = 'equipamento';
                }
            }

            const novoInsumo = {
                nome: document.getElementById('inputNome').value,
                categoria_id: categoriaId,
                tipo: tipo, // Tipo inferido da categoria
                unidade_medida: document.getElementById('inputUnidade').value,
                estoque_atual: parseFloat(document.getElementById('inputEstoqueInicial').value) || 0,
                estoque_minimo: parseFloat(document.getElementById('inputEstoqueMinimo').value) || 0,
                estoque_maximo: parseFloat(document.getElementById('inputEstoqueMaximo').value) || null,
                custo_unitario: parseFloat(document.getElementById('inputCusto').value) || 0,
                fornecedor: document.getElementById('inputFornecedor').value || null,
                ativo: true
            };

            try {
                const { data, error } = await insertRecord('insumos', novoInsumo);
                if (error) throw error;

                showStatus('‚úÖ Insumo cadastrado com sucesso!', 'success');
                document.getElementById('formCadastro').reset();
                await loadInsumos();

                // Redirecionar ap√≥s 2 segundos
                setTimeout(() => {
                    window.location.href = 'gestao-insumos.html';
                }, 2000);

            } catch (error) {
                console.error('Erro ao cadastrar:', error);
                showStatus('‚ùå Erro ao cadastrar: ' + error.message, 'error');
            }
        });

        // Vari√°vel global para modo de custo
        let custoMode = 'unitario';

        // Fun√ß√£o global para switchar modo
        window.switchCustoMode = function (mode) {
            custoMode = mode;

            const btnUnitario = document.getElementById('btnCustoUnitario');
            const btnPacote = document.getElementById('btnCustoPacote');
            const modoUnitario = document.getElementById('modoCustoUnitario');
            const modoPacote = document.getElementById('modoCustoPacote');

            if (mode === 'unitario') {
                btnUnitario.className = 'custo-btn flex-1 py-2.5 text-sm font-semibold rounded-lg bg-primary text-background-dark shadow-sm transition-all';
                btnPacote.className = 'custo-btn flex-1 py-2.5 text-sm font-medium rounded-lg text-slate-600 dark:text-slate-400 transition-all';

                modoUnitario.classList.remove('hidden');
                modoUnitario.classList.add('grid');
                modoPacote.classList.add('hidden');
                modoPacote.classList.remove('grid');
            } else {
                btnPacote.className = 'custo-btn flex-1 py-2.5 text-sm font-semibold rounded-lg bg-primary text-background-dark shadow-sm transition-all';
                btnUnitario.className = 'custo-btn flex-1 py-2.5 text-sm font-medium rounded-lg text-slate-600 dark:text-slate-400 transition-all';

                modoPacote.classList.remove('hidden');
                modoPacote.classList.add('grid');
                modoUnitario.classList.add('hidden');
                modoUnitario.classList.remove('grid');
            }

            calcularCusto();
        };

        // Calcular custo unit√°rio em tempo real
        function calcularCusto() {
            let custoUnit;

            if (custoMode === 'unitario') {
                custoUnit = parseFloat(document.getElementById('inputCustoUnitario').value) || 0;
            } else {
                const qtd = parseFloat(document.getElementById('inputQtdPacote').value) || 0;
                const valorTotal = parseFloat(document.getElementById('inputValorPacote').value) || 0;
                custoUnit = qtd > 0 ? (valorTotal / qtd) : 0;
            }

            const truncado = (Math.floor(custoUnit * 100000) / 100000).toFixed(5);
            document.getElementById('custoCalculado').textContent = truncado.replace('.', ',');
        }

        // Event listeners para c√°lculo em tempo real
        document.getElementById('inputQtdUnitario').addEventListener('input', calcularCusto);
        document.getElementById('inputCustoUnitario').addEventListener('input', calcularCusto);
        document.getElementById('inputQtdPacote').addEventListener('input', calcularCusto);
        document.getElementById('inputValorPacote').addEventListener('input', calcularCusto);

        // Form de Entrada de Estoque
        document.getElementById('formEntrada').addEventListener('submit', async (e) => {
            e.preventDefault();

            const insumoId = document.getElementById('selectInsumo').value;

            // Pegar valores baseado no modo
            let quantidade, custoUnitario;

            if (custoMode === 'unitario') {
                quantidade = parseFloat(document.getElementById('inputQtdUnitario').value);
                custoUnitario = parseFloat(document.getElementById('inputCustoUnitario').value);
            } else {
                quantidade = parseFloat(document.getElementById('inputQtdPacote').value);
                const valorTotal = parseFloat(document.getElementById('inputValorPacote').value);
                custoUnitario = valorTotal / quantidade;
            }

            if (!insumoId || !quantidade || !custoUnitario) {
                showStatus('‚ùå Preencha todos os campos', 'error');
                return;
            }

            const insumo = insumos.find(i => i.id == insumoId);
            if (!insumo) {
                showStatus('‚ùå Insumo n√£o encontrado', 'error');
                return;
            }

            const novoEstoque = parseFloat(insumo.estoque_atual) + quantidade;

            // Calcular custo m√©dio ponderado
            const estoqueAtual = parseFloat(insumo.estoque_atual) || 0;
            const custoAtual = parseFloat(insumo.custo_unitario) || 0;
            const custoMedioPonderado = ((estoqueAtual * custoAtual) + (quantidade * custoUnitario)) / novoEstoque;

            try {
                // 1. Atualizar estoque e custo do insumo
                const { error: updateError } = await updateRecord('insumos', insumoId, {
                    estoque_atual: novoEstoque,
                    custo_unitario: (Math.floor(custoMedioPonderado * 100000) / 100000).toFixed(5)
                });

                if (updateError) throw updateError;

                // 2. Registrar movimenta√ß√£o no hist√≥rico
                const movimentacao = {
                    insumo_id: parseInt(insumoId),
                    tipo: 'entrada',
                    quantidade: parseFloat(quantidade),
                    estoque_anterior: parseFloat(estoqueAtual),
                    estoque_atual: parseFloat(novoEstoque),
                    custo_unitario: parseFloat((Math.floor(custoUnitario * 100000) / 100000).toFixed(5)),
                    data_movimentacao: new Date().toISOString(),
                    motivo: 'Compra/Entrada de estoque',
                    referencia_tipo: 'compra',
                    referencia_id: null
                };

                console.log('üìù Tentando registrar movimenta√ß√£o:', movimentacao);

                const { data: movData, error: movError } = await insertRecord('movimentacoes_estoque', movimentacao);

                if (movError) {
                    console.error('‚ùå Erro ao registrar movimenta√ß√£o:', movError);
                    showStatus('‚ö†Ô∏è Estoque atualizado, mas hist√≥rico n√£o foi salvo: ' + movError.message, 'error');
                } else {
                    console.log('‚úÖ Movimenta√ß√£o registrada:', movData);
                }

                showStatus('‚úÖ Entrada registrada com sucesso!', 'success');
                document.getElementById('formEntrada').reset();
                await loadInsumos();

                // Redirecionar ap√≥s 2 segundos
                setTimeout(() => {
                    window.location.href = 'gestao-insumos.html';
                }, 2000);

            } catch (error) {
                console.error('Erro ao registrar entrada:', error);
                showStatus('‚ùå Erro ao registrar entrada: ' + error.message, 'error');
            }
        });

        // Status message
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `p-4 rounded-xl mb-4 max-w-7xl mx-auto ${type === 'success'
                ? 'bg-green-500/20 border border-green-500/50 text-green-300'
                : 'bg-red-500/20 border border-red-500/50 text-red-300'}`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');

            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 4000);
        }

        // Switch between tabs (APENAS MOBILE)
        window.switchTab = function (tab) {
            document.getElementById('tab-cadastro').classList.remove('active');
            document.getElementById('tab-entrada').classList.remove('active');
            document.getElementById('tab-' + tab).classList.add('active');

            const btnCadastro = document.getElementById('btn-cadastro');
            const btnEntrada = document.getElementById('btn-entrada');

            if (tab === 'cadastro') {
                btnCadastro.classList.add('bg-primary', 'text-background-dark', 'shadow-sm', 'font-semibold');
                btnCadastro.classList.remove('text-slate-600', 'dark:text-slate-400', 'font-medium');

                btnEntrada.classList.remove('bg-primary', 'text-background-dark', 'shadow-sm', 'font-semibold');
                btnEntrada.classList.add('text-slate-600', 'dark:text-slate-400', 'font-medium');
            } else {
                btnEntrada.classList.add('bg-primary', 'text-background-dark', 'shadow-sm', 'font-semibold');
                btnEntrada.classList.remove('text-slate-600', 'dark:text-slate-400', 'font-medium');

                btnCadastro.classList.remove('bg-primary', 'text-background-dark', 'shadow-sm', 'font-semibold');
                btnCadastro.classList.add('text-slate-600', 'dark:text-slate-400', 'font-medium');
            }
        };

        // Carregar ao iniciar
        loadInsumos();
        loadCategoriasInsumos();
    </script>
</body>

</html>